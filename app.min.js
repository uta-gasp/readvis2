"use strict";function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _toArray(a){return Array.isArray(a)?a:Array.from(a)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h.return&&h.return()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();window.ReadVis2=window.ReadVis2||{};var ReadVis2=window.ReadVis2;ReadVis2.init=function(a){ReadVis2.loadingCallbacks.forEach(function(a){a()}),"undefined"!=typeof window.firebase?ReadVis2.firebase=window.firebase.database().ref("school2"):window.alert("Please connect to the internet and reload the page"),ReadVis2.Visualization.init(a.visualization),ReadVis2.WordList.instance=new ReadVis2.WordList({container:a.wordList});var b=new ReadVis2.GazePlot({root:a.visualization}),c=new ReadVis2.TextSummary({root:a.visualization}),d=new ReadVis2.GazeReplay({root:a.visualization}),e=new ReadVis2.WordReplay({root:a.visualization,container:a.wordReplay}),f=new ReadVis2.StudentSummary({root:a.visualization,container:a.studentSummary});new ReadVis2.Controls({root:a.controls},{displaySession:b.queryData.bind(b),displayTextSummary:c.queryData.bind(c),gazeReplay:d.queryData.bind(d),wordReplay:e.queryData.bind(e),studentSummary:f.queryData.bind(f)}),new ReadVis2.Options({root:a.options,text:a.textContainer+" "+a.text},{gazePlot:b.options,textSummary:c.options,gazeReplay:d.options,wordReplay:e.options,studentSummary:f.options,_common:ReadVis2.Visualization.createCommonOptions(),_sgwm:ReadVis2.Visualization.createSGWMOptions()},{})},ReadVis2.loaded=function(a){ReadVis2.loadingCallbacks.push(a)},ReadVis2.loadingCallbacks=[],function(app){function a(a,c){this.root=document.querySelector(a.root);var d=app.Logger.moduleErrorPrinter("Controls");b=c||{},b.displaySession=b.displaySession||d("displaySession"),b.displayTextSummary=b.displayTextSummary||d("displayTextSummary"),b.wordReplay=b.wordReplay||d("wordReplay"),b.gazeReplay=b.gazeReplay||d("gazeReplay"),b.studentSummary=b.studentSummary||d("studentSummary");var e=this.root.querySelector(".gaze-plot");e.addEventListener("click",function(a){b.displaySession()});var f=this.root.querySelector(".text-summary");f.addEventListener("click",function(a){b.displayTextSummary(!0)});var g=this.root.querySelector(".gaze-replay");g.addEventListener("click",function(a){b.gazeReplay(!0)});var h=this.root.querySelector(".word-replay");h.addEventListener("click",function(a){b.wordReplay(!0)});var i=this.root.querySelector(".student-summary");i.addEventListener("click",function(a){b.studentSummary(!0)})}var b=void 0;app.Controls=a}(window.ReadVis2),function(app){function a(a){this.saccadeColor=a.saccadeColor||"#08F",this.connectionColor=a.connectionColor||"#F00",this.showIDs=a.showIDs||!1,this.showConnections=void 0!==a.showConnections&&a.showConnections,this.showSaccades=void 0===a.showSaccades||a.showSaccades,this.showFixations=void 0===a.showFixations||a.showFixations,this.greyFixationColor=a.greyFixationColor||"rgba(0,0,0,0.5)",this.greyFixationSize=a.greyFixationSize||15,this.fixationNumberSize=a.fixationNumberSize||16,this.fixationNumberColor=a.fixationNumberColor||"#FF0",this.wordListUnits=a.wordListUnits||app.WordList.Units.MS;var b=.5;this._lineColors=["rgba(255,0,0,"+b,"rgba(255,255,0,"+b,"rgba(0,255,0,"+b,"rgba(0,255,224,"+b,"rgba(0,128,255,"+b,"rgba(255,0,255,"+b],this._unmappedFixationColor="#000",this._mergedFixationBorderColor="#808",app.Visualization.call(this,a),this.options={id:"gaze-plot",title:"Gaze plot",update:this.update.bind(this),options:app.Visualization.createOptions({colorMetric:{type:Array,items:["none","duration","char speed","syllable speed"],label:"Word color metric"},showConnections:{type:Boolean,label:"Show word-fixation connections"},connectionColor:{type:"#",label:"Connection color"},showSaccades:{type:Boolean,label:"Show saccades"},saccadeColor:{type:"#",label:"Saccade color"},showFixations:{type:Boolean,label:"Show fixations"},greyFixationColor:{type:"#",label:"Default fixation color"},greyFixationSize:{type:Number,step:1,label:"Default fixation size"},showIDs:{type:Boolean,label:"Show IDs"},fixationNumberSize:{type:Number,step:1,label:"ID font size"},fixationNumberColor:{type:"#",label:"ID color"},wordListUnits:{type:Array,items:Object.values(app.WordList.Units),label:"Word list units"}},this)},this._data=null}app.loaded(function(){a.prototype=Object.create(app.Visualization.prototype),a.prototype.base=app.Visualization.prototype,a.prototype.constructor=a,a.prototype.update=function(){this._pageIndex>=0&&this._mapAndShow()},a.prototype._fillCategories=function(a,b){var c=this,d=[];b.forEach(function(a){var b=a.val();b.name=c._getUserName(a),d.push(b)});var e=this._classifyUsersByGrade(d);for(var f in e){var g=this._addOption(a,f,f,e[f]);this._data&&this._data.grade===f&&(g.selected=!0)}return"Select a student"},a.prototype._load=function(a,b,c,d,e){var f=this,g=[];for(var h in d.sessions)g.push(h);var i=g[0],j=d.sessions[i],k=app.Visualization.formatDate(j.date),l=this._loadSession(i,j),m=this._loadText(j.text);Promise.all([l,m]).then(function(b){var d=_slicedToArray(b,2),g=d[0],h=d[1];f._data={user:c,grade:e,sessionName:k,sessionID:i,session:g,text:h},app.WordList.instance.show(),f._setSessionProps({speech:{enabled:g.meta.interaction.speech.enabled,value:Math.round(g.meta.interaction.speech.threshold)},syllab:{enabled:g.meta.interaction.syllabification.enabled,value:Math.round(g.meta.interaction.syllabification.threshold)}}),f._recreateWordIDsInEvents(f._data.session,f._data.text),f._setPageIndex(0),f._mapAndShow(),f._setPrevPageCallback(function(){f._prevPage()}),f._setNextPageCallback(function(){f._nextPage()}),f._setCloseCallback(void 0),a&&a()}).catch(function(a){window.alert(a)})},a.prototype._mapAndShow=function(){var a=this._data.session[this._pageIndex],b=this._data.session.meta.interaction.syllabification.hyphen;app.WordList.instance.fill(a.records,{hyphen:b,units:this.wordListUnits});var c={fixations:a.fixations,words:this._data.text[this._pageIndex]};if(c.fixations){var d=this._map(c).fixations,e=app.Metric.compute(c.words,this.colorMetric),f=this._getCanvas2D();this._setCanvasFont(f,this._data.session.meta.font),this._drawWords(f,c.words,{metricRange:e,showIDs:this.showIDs,hideBoundingBox:this.showIDs&&!this.showConnections,hyphen:b}),a.syllabifications&&this._drawSyllabifications(f,a.syllabifications,b),this.showFixations&&d&&this._drawFixations(f,d),this._setTitle(this._data.user+' reading "'+this._data.session.meta.textTitle+'" at '+this._data.sessionName)}},a.prototype._drawFixations=function(a,b){for(var c=void 0,d=void 0,e=0,f=0;f<b.length;f+=1)d=b[f],d.x<=0&&d.y<=0||(this.showSaccades&&c&&this._drawSaccade(a,c,d),this.showConnections&&d.word&&this._drawConnection(a,d,{x:d.word.left,y:d.word.top}),this._drawFixation(a,d,d.id),c=d,e++)},a.prototype._drawFixation=function(a,b,c){this.showIDs?this._drawGreyFixation(a,b,c):this._drawColoredFixation(a,b,c)},a.prototype._drawGreyFixation=function(a,b,c){a.fillStyle=this.greyFixationColor,a.beginPath(),a.arc(b._x?b._x:b.x,b.y,this.greyFixationSize,0,2*Math.PI),a.fill(),a.textAlign="center",a.textBaseline="middle",a.font="bold "+this.fixationNumberSize+"px Verdana",a.fillStyle=this.fixationNumberColor,a.fillText(""+c,b._x?b._x:b.x,b.y)},a.prototype._drawColoredFixation=function(a,b,c){void 0!==b.line?a.fillStyle=this._lineColors[b.line%this._lineColors.length]:a.fillStyle=this._unmappedFixationColor;var d=Math.round(Math.sqrt(b.duration))/2;a.beginPath(),a.arc(b.x,b.y,d,0,2*Math.PI),a.fill(),b.merged&&(a.strokeStyle=this._mergedFixationBorderColor,a.lineWidth=3,a.beginPath(),a.arc(b.x,b.y,d+3,0,2*Math.PI),a.stroke(),a.lineWidth=1)},a.prototype._drawSaccade=function(a,b,c){a.strokeStyle=this.saccadeColor,a.beginPath(),a.moveTo(this.showIDs&&b._x?b._x:b.x,b.y),a.lineTo(this.showIDs&&c._x?c._x:c.x,c.y),a.stroke()},a.prototype._drawConnection=function(a,b,c){a.strokeStyle=this.connectionColor,a.beginPath(),a.moveTo(this.showIDs&&b._x?b._x:b.x,b.y),a.lineTo(c.x,c.y),a.stroke()},a.prototype._prevPage=function(){this._data&&this._pageIndex>0&&(this._setPageIndex(this._pageIndex-1),this._mapAndShow())},a.prototype._nextPage=function(){this._data&&this._pageIndex<this._data.text.length-1&&(this._setPageIndex(this._pageIndex+1),this._mapAndShow())}}),app.GazePlot=a}(window.ReadVis2),function(app){function a(a){this.nameFontSize=a.nameFontSize||20,this.nameSpacing=1.5,b.basePointerSize=a.basePointerSize||b.basePointerSize,a.colorMetric=app.Metric.Type.NONE,app.Visualization.call(this,a),this.options={id:"gaze-replay",title:"Gaze replay",update:this.update.bind(this),options:app.Visualization.createOptions({nameFontSize:{type:Number,label:"Font size"},nameSpacing:{type:Number,step:.1,label:"Spacing"}},this)},this._data=null,this._tracks=null,this._tracksLegendLocation={x:this.nameFontSize+2,y:8},this._nameFontFamily="Calibri, Arial, sans-serif"}function b(a,c){this.root=a,this.name=c.meta.user,this.session=c,this.color=app.Colors.colors[b.colorIndex++%app.Colors.colors.length],this.pointerSize=8,this.fixationEndTimer=null,this.fixationGrowTimer=null,this.nextTimer=null,this.syllabTimer=null,this.fixations=null,this.currentFixation=null,this.currentDuration=0,this.fixationIndex=-1,this._lastPause=0,this.__next=this._next.bind(this)}app.loaded(function(){a.prototype=Object.create(app.Visualization.prototype),a.prototype.base=app.Visualization.prototype,a.prototype.constructor=a,a.prototype._fillCategories=function(a,b){var c=this,d=this._getTexts(b);d.forEach(function(b,d){var e=c._addOption(a,d,b.title,b.sessions);c._data&&c._data.textID===d&&(e.selected=!0)})},a.prototype._load=function(a,c,d,e){var f=this,g=this._loadText(c,e),h=[g];d.forEach(function(a,b){app.WordList.instance.hyphen=a.interaction.syllabification.hyphen,h.push(f._loadSession(b,a))}),Promise.all(h).then(function(d){var g=_toArray(d),h=g[0],i=g.slice(1);f._data={textID:c,textTitle:e,text:h,sessions:i,hyphen:i[0].meta.interaction.syllabification.hyphen,font:i[0].meta.font},b.colorIndex=0,f._tracks=[],i.forEach(function(a){f._tracks.push(new b(app.Visualization.root,a))}),f._setPageIndex(0),f._start(),f._setPrevPageCallback(function(){f._prevPage()}),f._setNextPageCallback(function(){f._nextPage()}),f._setCloseCallback(function(){f._stopAll()}),f._setRestartCallback(function(){f._stopAll(),f._start()}),f._setPauseCallback(function(){var a=!1;return f._tracks.forEach(function(b){a=b.togglePause()||a}),{previous:a?"play":"pause",current:a?"pause":"play"}}),a&&a()}).catch(function(a){window.alert(a)})},a.prototype._start=function(){if(this._tracks.length){this._setPlayerProps({a:110});var a=this._getCanvas2D();this._setTitle('"'+this._data.text.title+'" for '+this._data.sessions.length+" sessions");var b=this._data.text[this._pageIndex];this._setCanvasFont(a,this._data.font),this._drawWords(a,b,{metricRange:null,showIDs:!1,hideBoundingBox:!0,hyphen:this._data.hyphen}),this._drawNames(a),this._run(a)}},a.prototype._stopAll=function(){this._tracks&&this._tracks.forEach(function(a){return a.stop()})},a.prototype._run=function(a){var b=this;this._tracks.forEach(function(d,e){d.start(b._pageIndex,{fixation:function(a,b){},completed:function(){a.textAlign="left",a.textBaseline="top",a.strokeStyle="#000",a.fillStyle=d.color,a.font="bold "+b.nameFontSize+"px "+b._nameFontFamily,a.fillText(c,b._tracksLegendLocation.x-b.nameFontSize,b._tracksLegendLocation.y+b.nameSpacing*b.nameFontSize*e)},syllabification:function(c){b._setCanvasFont(a,b._data.font),b._drawSyllabification(a,c,b._data.hyphen)}})})},a.prototype._prevPage=function(){this._stopAll(),this._data&&this._pageIndex>0&&(this._setPageIndex(this._pageIndex-1),this._start())},a.prototype._nextPage=function(){this._stopAll(),this._data&&this._pageIndex<this._data.text.length-1&&(this._setPageIndex(this._pageIndex+1),this._start())},a.prototype._drawNames=function(a){var b=this;this._tracks.forEach(function(c,d){a.textAlign="left",a.textBaseline="top",a.fillStyle=c.color,a.font="bold "+b.nameFontSize+"px "+b._nameFontFamily,a.fillText(c.name,b._tracksLegendLocation.x,b._tracksLegendLocation.y+b.nameSpacing*b.nameFontSize*d)})}}),b.basePointerSize=6,b.fixationGrowInterval=100,b.colorIndex=0,b.prototype.start=function(a,b){return this.callbacks=b||{},this.callbacks.fixation=this.callbacks.fixation||function(){},this.callbacks.completed=this.callbacks.completed||function(){},this.callbacks.syllabification=this.callbacks.syllabification||function(){},this.fixations=this.session[a].fixations,this.fixations?(this.syllabifications=this.session[a].syllabifications,this.nextSyllabificationIndex=this.syllabifications?0:-1,this.fixationIndex=0,this.pointer=document.createElement("div"),this.pointer.classList.add("track-pointer"),this.pointer.classList.add("invisible"),this.root.appendChild(this.pointer),void(this.nextTimer=setTimeout(this.__next,1500))):void onCompleted()},b.prototype.stop=function(){this._stopFixationTimers(),this.nextTimer&&(clearTimeout(this.nextTimer),this.nextTimer=null),this.pointer&&(this.root.removeChild(this.pointer),this.pointer=null)},b.prototype.togglePause=function(){return!!this.pointer&&(this.nextTimer?(this._stopFixationTimers(),clearTimeout(this.nextTimer),this.nextTimer=null,!0):(this.nextTimer=setTimeout(this.__next,this._lastPause),this._moveFixation(this.currentFixation),!1))},b.prototype._stopFixationTimers=function(){this.fixationEndTimer&&(clearTimeout(this.fixationEndTimer),this.fixationEndTimer=null),this.fixationGrowTimer&&(clearInterval(this.fixationGrowTimer),this.fixationGrowTimer=null),this.syllabTimer&&(clearTimeout(this.syllabTimer),this.syllabTimer=null)},b.prototype._next=function(){var a=this.fixations[this.fixationIndex];this._moveFixation(a),this.fixationIndex++,this.fixationIndex<this.fixations.length?(this._lastPause=this.fixations[this.fixationIndex].ts-a.ts,this.nextTimer=setTimeout(this.__next,this._lastPause)):(this.callbacks.completed(),this.root.removeChild(this.pointer),this.pointer=null,this.nextTimer=null)},b.prototype._moveFixation=function(a){var c=this;this._stopFixationTimers(),a?(this._checkSyllabification(a),this.callbacks.fixation(a,this.pointer),a.x>0&&a.y>0&&(this.currentDuration=100,this._updatePointer(),this.pointer.classList.remove("invisible")),this.fixationEndTimer=setTimeout(function(){c._stopFixationTimers(),c.pointer&&c.pointer.classList.add("invisible")},a.duration),this.fixationGrowTimer=setInterval(function(){c._updatePointer()},b.fixationGrowInterval)):this.pointer.classList.add("invisible"),this.currentFixation=a},b.prototype._updatePointer=function(){if(this.currentFixation&&this.pointer){var a=Math.round(Math.sqrt(this.currentDuration));this.pointer.style="left: "+(this.currentFixation.x-a/2)+"px;\n                              top: "+(this.currentFixation.y-a/2)+"px;\n                              width: "+a+"px;\n                              height: "+a+"px;\n                              border-radius: "+a/2+"px;\n                              background-color: "+this.color+";",this.currentDuration+=b.fixationGrowInterval}},b.prototype._checkSyllabification=function(a){var b=this;if(!(this.nextSyllabificationIndex<0)){var c=this.syllabifications[this.nextSyllabificationIndex],d=a.tsSync+a.duration;c.ts<d&&(this.nextSyllabificationIndex++,this.nextSyllabificationIndex===this.syllabifications.length&&(this.nextSyllabificationIndex=-1),this.syllabTimer=setTimeout(function(){b.syllabTimer=null,b.callbacks.syllabification(c)},d-c.ts))}};var c=String.fromCharCode(10003);app.GazeReplay=a}(window.ReadVis2),function(app){function a(e,f,g){var h=this;a.instance=this,C=document.querySelector(e.root),z=f||{},A=g||{},B=[],this._style=document.createElement("style"),document.body.appendChild(this._style),C.addEventListener("click",function(a){a.target===C&&C.classList.add("invisible")});var i=C.querySelector(".save");i.addEventListener("click",function(a){p(h._style,B),C.classList.add("invisible"),c(B),d()});var j=C.querySelector(".apply");j.addEventListener("click",function(a){p(h._style,B),d()});var k=C.querySelector(".reset");k.addEventListener("click",function(a){localStorage.removeItem(D),location.reload()}),window.addEventListener("load",function(a){b(B),h._style.innerHTML=B.reduce(function(a,b){return a+b.selector+" { "+b.name+": "+b.initial+b.suffix+" !important; } "},""),n(B),r(),o(B)})}function b(a){var b=JSON.parse(localStorage.getItem(D));if(b){var c=function a(b,c){for(var d in b)if("css"!==d){var e=c[d],f=b[d];e&&("object"===("undefined"==typeof f?"undefined":_typeof(f))?a(f,e):"function"==typeof e.ref&&e.ref(f))}};if(c(b,z),b.css){var d=void 0,e=void 0,f=function(a){a.selector===d[0]&&a.name===d[1]&&(a.initial=b.css[e])};for(e in b.css)d=e.split("____"),a.forEach(f)}}}function c(a){var b={},c=function a(b,c){for(var d in c){var e=c[d];"function"==typeof e.ref?b[d]=e.ref():"object"===("undefined"==typeof e?"undefined":_typeof(e))&&(b[d]={},a(b[d],e))}};c(b,z),b.css={},a.forEach(function(a){b.css[a.selector+"____"+a.name]=a.value}),localStorage.setItem(D,JSON.stringify(b))}function d(){for(var a in z){var b=z[a];"function"==typeof b.update&&b.update()}}function e(a,b){var c=C.querySelectorAll(".group");c.forEach(function(a){var c=a.id;"_"!==c[0]&&b&&0!==c.indexOf(b)?a.classList.add("hidden"):a.classList.remove("hidden")}),C.classList.remove("invisible"),q(B)}function f(a){var b=a.toString(16);return 1===b.length?"0"+b:b}function g(a,b,c){return"#"+f(a)+f(b)+f(c)}function h(a){var b=/^\D+(\d+)\D+(\d+)\D+(\d+)\D+$/gim,c=b.exec(a);return g(parseInt(c[1]),parseInt(c[2]),parseInt(c[3]))}function i(a,b,c,d){return{hex:"#"+f(a)+f(b)+f(c),a:void 0===d?1:d}}function j(a,b){var c=Number.parseInt(a.substr(1,2),16),d=Number.parseInt(a.substr(3,2),16),e=Number.parseInt(a.substr(5,2),16);return"rgba("+c+","+d+","+e+","+b+")"}function k(a){var b=/^\D+(\d+)\D+(\d+)\D+(\d+)\D*(\d|.+)\D+$/gim,c=b.exec(a);return i(parseInt(c[1]),parseInt(c[2]),parseInt(c[3]),c[4]?parseFloat(c[4]):void 0)}function l(a){if("#"!==a[0])return"#000000";if(7===a.length)return a;if(4===a.length){var b=a[1],c=a[2],d=a[3];return"#"+b+b+c+c+d+d}return"#000000"}function m(a){for(var b=a.indexOf("-");b>=0;){var c=a.charAt(b+1);a=a.replace("-"+c,c.toUpperCase()),b=a.indexOf("-")}return a}function n(a){for(var b=0;b<document.styleSheets.length;b++){var c=document.styleSheets[b],d=void 0;try{d=c.cssRules}catch(a){continue}if(d)for(var e=0;e<d.length;e++){var f=d[e];if(f)for(var g=0;g<a.length;g++){var i=a[g];f.selectorText===i.selector&&(void 0===i.initial&&("color"===i.type?i.initial=h(f.style.color):"string"===i.type&&(i.initial=f.style[m(i.name)])),i.value=i.initial)}}}}function o(a){for(var b=0;b<a.length;b++){var c=a[b];c.editor=C.querySelector("#"+c.id),"color"===c.type?c.editor.value=c.initial:"string"===c.type&&(c.editor.value=c.initial)}}function p(a,b){for(var c="",d=0;d<b.length;d++){var e=b[d];"color"===e.type?e.value=e.editor.value:"string"===e.type&&(e.value=e.editor.value),c+=e.selector+" { "+e.name+": "+e.value+e.suffix+" !important; } "}a.innerHTML=c}function q(a){for(var b=0;b<a.length;b++){var c=a[b];"color"===c.type?c.editor.value=c.value:"string"===c.type&&(c.editor.value=c.value)}}function r(){var a=C.querySelector(".options"),b=function(b){var c=z[b],d=document.createElement("div");d.classList.add("group"),d.id=c.id+"_group";var e=document.createElement("div");if(e.classList.add("name"),e.textContent=c.title,d.appendChild(e),c.options instanceof Array)c.options.forEach(function(a){var b=s(a,c.id);d.appendChild(b)});else for(var f in c.options){var g=c.options[f],h=t(g,c.id+"_"+f);d.appendChild(h)}a.appendChild(d)};for(var c in z)b(c)}function s(a,b){var c=document.createElement("div");c.classList.add("subgroup");var d=document.createElement("div");d.classList.add("subname"),d.textContent=a.title,c.appendChild(d);for(var e in a.options){var f=a.options[e],g=t(f,b+"_"+e);c.appendChild(g)}return c}function t(a,b){var c=document.createElement("div");c.classList.add("row");var d=document.createElement("div");return d.classList.add("label"),d.textContent=a.label,c.appendChild(d),a.type===Array?c.appendChild(u(a,b)):a.type===Boolean?c.appendChild(v(a,b)):a.type===String?c.appendChild(w(a,b)):"#"===a.type?c.appendChild(x(a,b)):a.type===Number&&c.appendChild(y(a,b)),c}function u(a,b){var c=document.createElement("select");return c.classList.add("value"),c.classList.add(b),a.items.forEach(function(a){var b=document.createElement("option");b.value=a,b.textContent=a,c.appendChild(b)}),c.selectedIndex=a.ref(),c.addEventListener("change",function(b){a.ref(a.items[b.target.selectedIndex])}),c}function v(a,b){var c=document.createElement("span"),d=document.createElement("input");d.type="checkbox",d.classList.add(b),d.checked=a.ref(),d.addEventListener("click",function(b){a.ref(b.target.checked)});var e=document.createElement("label"),f=document.createElement("div");return f.textContent="✔",e.appendChild(f),c.appendChild(d),c.appendChild(e),c}function w(a,b){var c=document.createElement("input");c.type="text",c.classList.add("value"),c.classList.add(b);var d=a.ref();return c.value=d,c.addEventListener("click",function(b){a.ref(b.target.value)}),c}function x(a,b){var c=document.createElement("input");c.type="color",c.classList.add("value"),c.classList.add(b);var d=a.ref();if("#"===d[0])c.value=l(d),c.addEventListener("change",function(b){a.ref(b.target.value)});else{var e=k(d);c.value=e.hex,c.alpha=e.a,c.addEventListener("change",function(b){a.ref(j(b.target.value,b.target.alpha))})}return c}function y(a,b){var c=document.createElement("input");return c.type="number",void 0!==a.step&&(c.step=a.step),void 0!==a.min&&(c.min=a.min),void 0!==a.max&&(c.max=a.max),c.classList.add("value"),c.classList.add(b),c.value=a.ref(),c.addEventListener("change",function(b){a.ref(+b.target.value)}),c}a.instance=null,a.prototype.show=function(a){e(null,a)};var z=void 0,A=void 0,B=void 0,C=void 0,D="readvis2_options";app.Options=a}(window.ReadVis2),function(app){function a(a){this._container=document.querySelector(a.container),this._statistics=["Sessions","Reading time","WPM","Seconds per word","Fixation, ms","Hyphenations"],app.Visualization.call(this,a),this.options={id:"student-summary",title:"Student summary",update:this.update.bind(this),options:app.Visualization.createOptions({},this)},this._users=null,this._grade=null}function b(a){var b=""+a;return b.length<2&&(b="0"+b),b}app.loaded(function(){a.prototype=Object.create(app.Visualization.prototype),a.prototype.base=app.Visualization.prototype,a.prototype.constructor=a,a.prototype._fillCategories=function(a,b){var c=this,d=[];b.forEach(function(a){var b=a.val();b.name=c._getUserName(a),d.push(b)});var e=this._classifyUsersByGrade(d);for(var f in e){var g=this._addOption(a,f,f,e[f]);this._grade===f&&(g.selected=!0)}return"Select students"},a.prototype._load=function(a,b,c,d){var e=this,f=new Map,g=[];this._grade=d,c.forEach(function(a,b){for(var c in a.sessions){var d=a.sessions[c];d.user=a.name,g.push(e._loadSession(c,d)),f.has(d.text)||f.set(d.text,e._loadText(d.text,d.textTitle))}});var h=Array.from(f.values());Promise.all([].concat(_toConsumableArray(h),g)).then(function(b){c.forEach(function(a,b){for(var c in a.sessions){var d=e._sessions[c];if(d){var f=a.sessions[c];f.data=d;for(var g in e._texts)if(+g===+f.text){f.pages=e._texts[g];break}}else console.error("No session data "+c+" for "+b)}}),e._users=c,e._setCloseCallback(function(){e._container.classList.add("invisible")}),e._show(),a&&a()}).catch(function(a){e._users=null,window.alert(a)})},a.prototype._show=function(){var a=this;if(this._users.size){this._getCanvas2D();this._setTitle(this._users.size+" students from "+this._grade);var c=this._container.querySelector("table");c.innerHTML="",this._users.forEach(function(d){var e=c.insertRow(),f=e.insertCell();f.textContent=d.name,d.statistics=a._getUserStatistics(d),d.statistics.forEach(function(a,c){var d=e.insertCell();1===c?d.textContent=(a/60).toFixed(0)+":"+b(a%60):d.textContent=a})});var d=c.createTHead(),e=c.createTFoot(),f=d.insertRow(),g=e.insertRow();f.insertCell(),g.insertCell(),this._statistics.forEach(function(b){var d=f.insertCell();d.textContent=b,d.addEventListener("click",function(b){var d=a._updateTableHeader(c,b.target.cellIndex);a._sortTable(c,b.target.cellIndex-1,d)})}),c.scrollTop=0,this._container.classList.remove("invisible")}},a.prototype._updateTableHeader=function(a,b){var c=a.tHead.rows[0].cells,d=0;c[b].classList.contains("up")?d=1:c[b].classList.contains("down")&&(d=-1);for(var e=0;e<c.length;e++)c[e].classList.remove("sorted"),c[e].classList.remove("up"),c[e].classList.remove("down");return c[b].classList.add("sorted"),c[b].classList.add(d<1?"up":"down"),d<1?1:-1},a.prototype._sortTable=function(a,c,d){var e=[];this._users.forEach(function(a){e.push(a)}),e.sort(function(a,b){return d>0?b.statistics[c]-a.statistics[c]:a.statistics[c]-b.statistics[c]});var f=a.tBodies[0].rows;e.forEach(function(a,c){var d=f[c];d.cells[0].textContent=a.name,a.statistics.forEach(function(a,c){var e=d.cells[c+1];1===c?e.textContent=(a/60).toFixed(0)+":"+b(a%60):e.textContent=a})})},a.prototype._getUserStatistics=function(a){var b=[],c=Object.values(a.sessions);b.push(c.length);var d=0,e=0,f=0,g={count:0,duration:0,hyphenations:0};c.forEach(function(a){for(var b=a.data,c=a.pages,h=void 0,i=b.length-1;i>=0;i--){var j=b[i];if(j.fixations){h=j;break}}if(h){var k=h.fixations[h.fixations.length-1];d+=k.tsSync+k.duration,f+=c.reduce(function(a,b){return a+b.length},0),g=b.reduce(function(a,b){return{count:a.count+b.fixations.length,duration:a.duration+b.fixations.reduce(function(a,b){return a+b.duration},0),hyphenations:a.hyphenations+(b.syllabifications?b.syllabifications.length:0)}},g),e++}});var h=new Date(0,0,0,0,0,Math.round(d/1e3));return b.push(60*h.getMinutes()+h.getSeconds()),b.push((f/(d/6e4)).toFixed(0)),b.push((d/f/1e3).toFixed(2)),b.push(Math.round(g.duration/g.count)),b.push(g.hyphenations/c.length),b}}),app.StudentSummary=a}(window.ReadVis2),function(app){function a(a){this.fixationColor=a.fixationColor||"#000",this.showFixations=void 0===a.showFixations||a.showFixations,this.showRegressions=void 0!==a.showRegressions&&a.showRegressions,app.Visualization.call(this,a),this.options={id:"text-summary",title:"Text summary",update:this.update.bind(this),options:app.Visualization.createOptions({fixationColor:{type:"#",label:"Fixation color"},showFixations:{type:Boolean,label:"Show fixations"},showRegressions:{type:Boolean,label:"Highlight regressions"}},this)},this._data=null}app.loaded(function(){a.prototype=Object.create(app.Visualization.prototype),a.prototype.base=app.Visualization.prototype,a.prototype.constructor=a,a.prototype.update=function(){this._pageIndex>=0&&this._mapAndShow()},a.prototype._fillCategories=function(a,b){var c=this,d=this._getTexts(b);d.forEach(function(b,d){var e=c._addOption(a,d,b.title,b.sessions);c._data&&c._data.textID===d&&(e.selected=!0)})},a.prototype._load=function(a,b,c,d){var e=this,f=this._loadText(b,d),g=[f];c.forEach(function(a,b){app.WordList.instance.hyphen=a.interaction.syllabification.hyphen,g.push(e._loadSession(b,a))}),Promise.all(g).then(function(c){var f=_toArray(c),g=f[0],h=f.slice(1);e._data={textID:b,textTitle:d,text:g,sessions:h},app.WordList.instance.show(),e._data.sessions.forEach(function(a){e._recreateWordIDsInEvents(a,e._data.text)}),e._setPageIndex(0),e._mapAndShow(),e._setPrevPageCallback(function(){e._prevPage()}),e._setNextPageCallback(function(){e._nextPage()}),e._setCloseCallback(void 0),a&&a()}).catch(function(a){window.alert(a)})},a.prototype._mapAndShow=function(){var a=this;app.WordList.instance.clear();var b=this._getCanvas2D(),c=this._data.sessions[0].meta,d=this._data.text[this._pageIndex],e=app.Metric.compute(d,this.colorMetric);this._setCanvasFont(b,c.font),this._drawWords(b,d,{metricRange:e,showIDs:!1,hideBoundingBox:!0,hyphen:c.interaction.syllabification.hyphen}),this._data.sessions.forEach(function(c){var e=c[a._pageIndex];app.WordList.instance.fill(e.records,{preserve:!0,hyphen:c.meta.interaction.syllabification.hyphen});var f={fixations:e.fixations,words:d},g=a._map(f).fixations;a.showFixations&&g&&a._drawFixations(b,g)}),this._setTitle('"'+this._data.text.title+'" for '+this._data.sessions.length+" sessions")},a.prototype._drawWord=function(a,b,c){this.base._drawWord.call(this,a,b,c),this.showRegressions&&b.regressionCount&&(a.lineWidth=b.regressionCount+1,a.strokeRect(b.x,b.y,b.width,b.height),a.lineWidth=1)},a.prototype._drawFixations=function(a,b){a.fillStyle=this.fixationColor,b.forEach(function(b){b.x<=0&&b.y<=0||(a.beginPath(),a.arc(b.x,b.y,2,0,2*Math.PI),a.fill())})},a.prototype._prevPage=function(){this._data&&this._pageIndex>0&&(this._setPageIndex(this._pageIndex-1),this._mapAndShow())},a.prototype._nextPage=function(){this._data&&this._pageIndex<this._data.text.length-1&&(this._setPageIndex(this._pageIndex+1),this._mapAndShow())}}),app.TextSummary=a}(window.ReadVis2),function(app){function a(a){a=a.substr(1);var b=3===a.length?1:2,c=parseInt(d(a.substr(0*b,b),3-b),16),e=parseInt(d(a.substr(1*b,b),3-b),16),f=parseInt(d(a.substr(2*b,b),3-b),16),g=255-c,h=255-e,i=255-f,j=Math.min(g,h,i);return g=(g-j)/(255-j),h=(h-j)/(255-j),i=(i-j)/(255-j),{c:g,m:h,y:i,k:j/255}}function b(a){var b=a.c*(1-a.k)+a.k,d=a.m*(1-a.k)+a.k,e=a.y*(1-a.k)+a.k;return b=Math.round(255*(1-b)+.5),d=Math.round(255*(1-d)+.5),e=Math.round(255*(1-e)+.5),"#"+c(b)+c(d)+c(e)}function c(a,b){var c=Number(a).toString(16);for(b=b||0===b?b:2;c.length<b;)c="0"+c;return c}function d(a,b){for(var c="",d=0;d<b;d+=1)c+=a;return c}var e={};e.mix=function(c){for(var d=0,e=0,f=0,g=0,h=0,i=0;i<c.length;i+=1){var j=a(c[i].color),k=c[i].weight;d+=j.c*k,e+=j.m*k,f+=j.y*k,g+=j.k*k,h+=k}var l={c:d/h,m:e/h,y:f/h,k:g/h};return b(l)},e.rgb2rgba=function(b,c){var d=a(b),e=d.c*(1-d.k)+d.k,f=d.m*(1-d.k)+d.k,g=d.y*(1-d.k)+d.k;return e=Math.round(255*(1-e)),f=Math.round(255*(1-f)),g=Math.round(255*(1-g)),"rgba("+e+","+f+","+g+","+c+")"},e.colors=["#5DA5DA","#FAA43A","#60BD68","#F17CB0","#B2912F","#B276B2","#DECF3F","#4D4D4D","#F15854"],app.Colors=e}(window.ReadVis2),function(app){app.DataExporter={save:function(a,b){var c=new Blob([a],{type:"text/plain"}),d=document.createElement("a");d.download=b,d.innerHTML="Download File";var e=window.URL||window.webkitURL;d.href=e.createObjectURL(c),d.onclick=function(a){document.body.removeChild(a.target)},d.style.display="none",document.body.appendChild(d),d.click()}}}(window.ReadVis2),function(app){function a(d,e){this.id=Symbol(e),this._record=[],this.level=0,this.generalPadding="";for(var f=0;f<c.size;f+=1)this.generalPadding+=a.padding;c.set(this.id,this),b.enabled&&(console.log(""+this.generalPadding+d),e&&console.log(a.padding+this.generalPadding+e))}var b={enabled:!0};b.moduleErrorPrinter=function(a){return void 0!==window.ReadVis2?function(){}:function(b){console.error('Missing "'+b+'" service for "'+a+'"')}},b.moduleLogPrinter=function(a){var c=function(a){console.log(a)};return void 0!==window.ReadVis2?function(){}:function(d){for(var e=arguments.length,f=Array(e>1?e-1:0),g=1;g<e;g++)f[g-1]=arguments[g];b.enabled&&(console.log("\n",a),console.log(d),f.forEach(function(a){void 0!==a&&(a instanceof Array?a.forEach(c):console.log(a))}))}},b.forModule=function(d){return{start:function(b){return new a(d,b)},end:function(a){c.delete(a.id)},log:function(){for(var a=arguments.length,c=Array(a),e=0;e<a;e++)c[e]=arguments[e];
b.enabled&&console.log(d,c)}}},a.padding="    ",a.prototype.push=function(){for(var c="",d=0;d<this.level;d+=1)c+=a.padding;b.enabled&&console.log(a.padding+this.generalPadding+c+Array.prototype.join.call(arguments," "))},a.prototype.levelUp=function(a){void 0!==a&&this.push(a),this.level+=1},a.prototype.levelDown=function(){this.level-=1,this.level<0&&(this.level=0)},a.prototype.notEmpty=function(){return this._record.length>0},a.prototype.print=function(){b.enabled&&console.log(a.padding+this.generalPadding+this._record.join("\n"+a.padding))};var c=new Map;app.Logger=b}(window.ReadVis2),function(app){function a(a,b){var c=0;return a.duration>f&&(c=(a.duration-f)/(b-f)),c}function b(a,b){var c=0;return a.charSpeed>0&&(c=1-a.charSpeed/b),c}function c(a,b){var c=0;return a.syllableSpeed>0&&(c=1-a.syllableSpeed/b),c}var d={};d.compute=function(a,b){var c=0;return a.forEach(function(a){if(a.fixations){var e=a.fixations.reduce(function(a,b){return a.duration+=b.duration,a.regressionCount+=b.isRegression?1:0,a},{duration:0,regressionCount:0}),f=app.Syllabifier.clean(a.text);a.duration=e.duration,a.regressionCount=e.regressionCount,a.charSpeed=1e3*f.length/a.duration,a.syllableSpeed=1e3*app.Syllabifier.syllables(f).length/a.duration;var g=0;switch(b){case d.Type.DURATION:g=a.duration;break;case d.Type.CHAR_SPEED:g=a.charSpeed;break;case d.Type.SYLL_SPEED:g=a.syllableSpeed}c<g&&(c=g)}}),c},d.getAlpha=function(a,b,c){return e[b](a,c)};var e=[function(){return 0},a,b,c],f=100;d.Type={NONE:0,DURATION:1,CHAR_SPEED:2,SYLL_SPEED:3},app.Metric=d}(window.ReadVis2);var reduce=Function.bind.call(Function.call,Array.prototype.reduce),isEnumerable=Function.bind.call(Function.call,Object.prototype.propertyIsEnumerable),concat=Function.bind.call(Function.call,Array.prototype.concat),keys=Reflect.ownKeys;Object.values||(Object.values=function(a){return reduce(keys(a),function(b,c){return concat(b,"string"==typeof c&&isEnumerable(a,c)?[a[c]]:[])},[])}),Object.entries||(Object.entries=function(a){return reduce(keys(a),function(b,c){return concat(b,"string"==typeof c&&isEnumerable(a,c)?[[c,a[c]]]:[])},[])}),function(app){function a(a){return f.includes(a)?"V":g.includes(a)?"C":"_"}function b(a,b){return a.toLowerCase().indexOf(b)>=0}function c(a,b,c){for(var e=a.toLowerCase().indexOf(b),f=b.length,g=a.substr(0,e),h=a.substr(e+f),i=Array.from(c),j=[],k="",l=e,m=0;l<e+f;l++){var n=a.charAt(l);for(n===n.toUpperCase()&&(i[m]=n),k+=i[m];i[++m]===d;)k&&j.push(k),k=""}return k&&j.push(k),j[0]=g+j[0],j[j.length-1]=j[j.length-1]+h,j}var d=String.fromCharCode(183),e=function(a){return{krokotiili:"kro"+a+"ko"+a+"tii"+a+"li",talviunille:"tal"+a+"vi"+a+"u"+a+"nil"+a+"le",hankien:"han"+a+"ki"+a+"en",metsien:"met"+a+"si"+a+"en","talviyön":"tal"+a+"vi"+a+"yön",avantouinnille:"a"+a+"van"+a+"to"+a+"uin"+a+"nil"+a+"le",kreikassa:"krei"+a+"kas"+a+"sa",maanosaa:"maan"+a+"o"+a+"saa",kansanedustajaa:"kan"+a+"san"+a+"e"+a+"dus"+a+"ta"+a+"jaa",kuntien:"Kun"+a+"ti"+a+"en",vuodenaikaa:"vuo"+a+"den"+a+"ai"+a+"kaa",kaikkien:"kaik"+a+"ki"+a+"en","finlandia-talossa":"fin"+a+"lan"+a+"di"+a+"a-ta"+a+"los"+a+"sa","weegee:ssä":"weegee:ssä","käsityöläisalue":"kä"+a+"si"+a+"työ"+a+"läis"+a+"a"+a+"lu"+a+"e",talviurheilukeskus:"tal"+a+"vi"+a+"ur"+a+"hei"+a+"lu"+a+"kes"+a+"kus",mualiman:"mua"+a+"li"+a+"man",kattokruunuun:"kat"+a+"to"+a+"kruu"+a+"nuun",unien:"u"+a+"ni"+a+"en",ikkunanpielien:"ik"+a+"ku"+a+"nan"+a+"pie"+a+"li"+a+"en","pohjois-suomessa":"poh"+a+"jois-suo"+a+"mes"+a+"sa"}}(d),f=["a","o","u","i","e","ä","ö","y"],g=["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","z"],h=["ai","ei","oi","ui","yi","äi","öi","au","eu","iu","ou","ey","iy","äy","öy","ie","uo","yö"],i={clean:function(a,b){var c=b||d,e=new RegExp(""+c,"g");return a.replace(e,"")},syllables:function(d){var f=Object.keys(e).find(function(a){return b(d,a)});if(f)return c(d,f,e[f]);for(var g=[],i="",j=!1,k=d.length-1;k>=0;k--){var l=!1,m=d[k],n=a(m);if("V"===n){if(k<d.length-1){var o=d[k+1],p=a(o);o===m||p!==n||h.includes(m+o)||(i&&g.unshift(i),i="")}j=!0}else if("C"===n&&j&&(l=k>0,1===k)){var q=d[k-1],r=a(q);r===n&&(l=!1)}i=m+i,l&&(g.unshift(i),i="",j=!1)}return i&&g.unshift(i),g},syllabify:function(a,b){var c=b||d,e=i.clean(a,c);return i.syllables(e).join(c)},getPrefixAndSuffix:function(a,b){for(var c=Array.from(a),d=[],e=[],f=0;f<c.length&&c[f++]===b;)d.push(b);for(f=c.length-1;f>=0&&c[f--]===b;)e.push(b);return[d.join(""),e.join("")]}};app.Syllabifier=i}(window.ReadVis2),function(app){function a(b){var c=this;a._instaces.push(this),this.wordColor=b.wordColor||"#666",this.wordHighlightColor=b.wordHighlightColor||"#606",this.wordRectColor=b.wordRectColor||"#888",this.syllabification=Object.assign({background:"#fcc",color:"#060"},b.syllabification),this.indexColors=Object.assign({line:"#080",word:"#008"},b.indexColors),this.colorMetric=void 0!==b.colorMetric?b.colorMetric:app.Metric.Type.DURATION,this._gradeTexts={"2nd grade":["Krokotiili hiihtää kevääseen","Heinähattu, Vilttitossu ja iso Elsa","Muumilaaksossa","Olympialaiset"],"3rd grade":["Suomi on tasavalta","Suomi ja suomalaisuus","Helsinki on Suomen pääkaupunki","Suomen kaupunkeja"],"ITK 2017":["Koulutuspolitiikkaa","Mielensäpahoittaja","Difficult English"],Kaustinen:[]},this._gradeTexts={"2nd grade":[1242688269,4186627776,3500610092,2836645924],"3rd grade":[3125237432,2542361273,2123841483,1992773228],"ITK 2017":[1161576252,2288695053,562169305],Kaustinen:[]},this._sessions={},this._texts={},this._SGWM={},this._initializeSGWMSettings(),this._pageIndex=-1,H=function(){c._onClosed()}}function b(a,b){return function(c){var d=a.split(".");if(void 0===c){var e=b[0];return d.forEach(function(a){e=e[a]}),e}b.forEach(function(a){for(var b=a,e=0;e<d.length-1;e++)b=b[d[e]];b[d[d.length-1]]=c})}}function c(b){a.active&&app.Options.instance.show(a.active.options.id)}function d(a){o.classList.add("invisible"),w.classList.add("invisible"),B.classList.add("invisible");var b=r.getContext("2d");b.clearRect(0,0,n,m),H&&H()}function e(a){if(s.classList.add("invisible"),u.multiple)if(u.selectedOptions.length){for(var b=new Map,c=0;c<u.selectedOptions.length;c++){var e=u.selectedOptions[c];b.set(e.value,e.data)}var f=t.selectedIndex<0?null:t.options[t.selectedIndex].value,g=t.selectedIndex<0?null:t.options[t.selectedIndex].textContent;E(l,f,b,g)}else d();else{var h=t.options[t.selectedIndex],i=u.options[u.selectedIndex];E(l,i.value,i.textContent,i.data,h.value)}p.classList.remove("invisible")}function f(b){var c=b.target.options[b.target.selectedIndex];if(c&&c.data){u.innerHTML="";var d=c.data;d.forEach(function(b,c){if(b.date){var d=b,e=a.formatDate(d.date);d.user&&(e+=new Array(Math.max(0,17-e.length)).join(String.fromCharCode(8210)),e+=" | "+d.user),g(u,c,e,d)}else if(b.sessions){var f=b;g(u,f.name,f.name,f)}})}}function g(a,b,c,d){var e=document.createElement("option");return e.value=b,e.textContent=c||b,d&&(e.data=d),a.appendChild(e),e}function h(a){F&&F()}function i(a){G&&G(),D.classList.remove("play"),D.classList.add("pause")}function j(a){I&&I()}function k(a){if(J){var b=J();D.classList.remove(b.current),D.classList.add(b.previous)}}function l(){p.classList.add("invisible")}a.init=function(b){o=document.querySelector(b),p=o.querySelector(".wait"),q=o.querySelector(".vis-title"),r=o.querySelector("canvas"),s=o.querySelector(".prompt"),t=s.querySelector(".categories"),u=s.querySelector(".items"),v=s.querySelector(".select"),w=o.querySelector(".props"),x=o.querySelector(".menu .navigation"),y=x.querySelector(".prev"),z=x.querySelector(".next"),A=x.querySelector(".page"),B=o.querySelector(".player"),C=B.querySelector(".restart"),D=B.querySelector(".pause"),s.classList.add("invisible"),a.root=o,o.querySelector(".settings").addEventListener("click",c),o.querySelector(".close").addEventListener("click",d),t.addEventListener("change",f),v.addEventListener("click",e),y.addEventListener("click",h),z.addEventListener("click",i),C.addEventListener("click",j),D.addEventListener("click",k)},a.formatTimeComponent=function(a){var b=""+a;return b.length<2&&(b="0"+b),b},a.formatDate=function(b){var c=new Date(b),d=a.formatTimeComponent(c.getHours()),e=a.formatTimeComponent(c.getMinutes());return c.getDate()+"."+(c.getMonth()+1)+"."+c.getFullYear()+" "+d+":"+e+" "},a.createOptions=function(c,d){if(d instanceof Array||(d=[d]),c instanceof Array)return c.map(function(b){return{title:b.title,options:a.createOptions(b.options,d)}});for(var e in c)c[e].ref=b(e,d);return c},a.createCommonOptions=function(){return{id:"_common",title:"Common",options:a.createOptions({wordColor:{type:"#",label:"Text color"},wordHighlightColor:{type:"#",label:"Highlighting color"},wordRectColor:{type:"#",label:"Word frame color"},"syllabification.background":{type:"#",label:"Syllabification background"},"syllabification.color":{type:"#",label:"Syllabification word color"}},a._instaces)}},a.createSGWMOptions=function(){return{id:"_sgwm",title:"Data mapping",options:a.createOptions([{title:"Fixation processing",options:a.createOptions({"_SGWM.FixationProcessorSettings.location.enabled":{type:Boolean,label:"By location"},"_SGWM.FixationProcessorSettings.location.marginX":{type:Number,step:10,label:"\tmargin X, px"},"_SGWM.FixationProcessorSettings.location.marginY":{type:Number,label:"\tmargin Y, px"},"_SGWM.FixationProcessorSettings.duration.enabled":{type:Boolean,label:"By duration"},"_SGWM.FixationProcessorSettings.duration.mergingDurationThreshold":{type:Number,label:"\tmerging threshold, ms"},"_SGWM.FixationProcessorSettings.duration.mergingDistanceThreshold":{type:Number,label:"\tmerging distance, px"},"_SGWM.FixationProcessorSettings.duration.removingDurationThreshold":{type:Number,label:"\tmin duration, ms"}})},{title:"Splitter",options:a.createOptions({"_SGWM.SplitToProgressionsSettings.left":{type:Number,step:.1,label:"Left margin, chars"},"_SGWM.SplitToProgressionsSettings.right":{type:Number,step:.1,label:"Right margin, chars"},"_SGWM.SplitToProgressionsSettings.verticalLine":{type:Number,step:.1,label:"Vertical margin, lines"},"_SGWM.SplitToProgressionsSettings.angle":{type:Number,step:.1,label:"Max incline, rad"}})},{title:"Merger",options:a.createOptions({"_SGWM.ProgressionMergerSettings.minLongSetLength":{type:Number,label:"Shortest progression, fixations"},"_SGWM.ProgressionMergerSettings.fitThreshold":{type:Number,step:.01,label:"Line separation threshold, lines"},"_SGWM.ProgressionMergerSettings.maxLinearGradient":{type:Number,step:.01,label:"Max line incline, rad"},"_SGWM.ProgressionMergerSettings.removeSingleFixationLines":{type:Boolean,label:"Remove unmerged single fixations"},"_SGWM.ProgressionMergerSettings.correctForEmptyLines":{type:Boolean,label:"Account for empty lines"},"_SGWM.ProgressionMergerSettings.currentLineSupportInCorrection":{type:Number,step:.05,label:"\tsupport current line by"},"_SGWM.ProgressionMergerSettings.intelligentFirstLineMapping":{type:Boolean,label:"Intelligent first reading line search"}})},{title:"Word mapper",options:a.createOptions({"_SGWM.WordMapperSettings.wordCharSkipStart":{type:Number,label:"Skip from start, chars"},"_SGWM.WordMapperSettings.wordCharSkipEnd":{type:Number,label:"Skip from end, chars"},"_SGWM.WordMapperSettings.scalingDiffLimit":{type:Number,step:.1,label:"Scaling diff limit"},"_SGWM.WordMapperSettings.rescaleFixationX":{type:Boolean,label:"Rescale fixations horizontally"},"_SGWM.WordMapperSettings.partialLengthMaxWordLength":{type:Number,label:"\tshort word, chars"},"_SGWM.WordMapperSettings.effectiveLengthFactor":{type:Number,step:.1,label:"\tlimit to"},"_SGWM.WordMapperSettings.ignoreTransitions":{type:Boolean,label:"Ignore transitions"}})}],a._instaces)}},a._instaces=[],a.SGWM={},a.prototype.queryData=function(b){var c=this;if(!K){a.active=this,o.classList.remove("invisible"),p.classList.remove("invisible"),A.textContent="",q.textContent="",this._enableNavigationButtons(!1,!1),K=!0;var d=app.firebase.child("users");d.once("value",function(a){if(K=!1,!a.exists())return void window.alert("No users exist in the database");var d=a;o.classList.contains("invisible")||c._showDataSelectionDialog(b,d)},function(a){K=!1,window.alert(a)})}},a.prototype.update=function(){},a.prototype._showDataSelectionDialog=function(a,b){p.classList.add("invisible"),t.innerHTML="",u.innerHTML="",u.multiple=!!a;var c=void 0;if(this._fillCategories){c=this._fillCategories(t,b);var d=new window.Event("change");t.dispatchEvent(d),t.classList.remove("invisible")}else this._fillItems&&(c=this._fillSessions(u,b),t.classList.add("invisible"));var e=s.querySelector(".title");e.textContent=c||"Select students",E=this._load.bind(this),s.classList.remove("invisible")},a.prototype._getUserName=function(a){return a.key},a.prototype._addOption=function(a,b,c,d){return g(a,b,c,d)},a.prototype._loadText=function(a,b){var c=this;return this._texts[a]||new Promise(function(d,e){var f=app.firebase.child("texts/"+a);f.once("value",function(f){if(!f.exists())return void e("Text "+a+" does not exist in the database");var g=f.val();g.title=b,c._texts[a]=g,d(g)},function(a){e(a)})})},a.prototype._loadSession=function(a,b){var c=this;return this._sessions[a]||new Promise(function(d,e){var f=app.firebase.child("sessions/"+a);f.once("value",function(f){if(!f.exists())return void e("Session "+a+" does not exist in the database");var g=f.val();g.meta=b,c._sessions[a]=g,d(g)},function(a){e(a)})})},a.prototype._getTexts=function(a){var b=this,c=new Map;return a.forEach(function(a){var d=a.val().sessions,e=!0,f=!1,g=void 0;try{for(var h,i=Object.keys(d)[Symbol.iterator]();!(e=(h=i.next()).done);e=!0){var j=h.value,k=d[j];if(k.user=b._getUserName(a),c.has(k.text))c.get(k.text).sessions.set(j,k);else{var l={title:k.textTitle||k.text,sessions:new Map};l.sessions.set(j,k),c.set(k.text,l)}}}catch(a){f=!0,g=a}finally{try{!e&&i.return&&i.return()}finally{if(f)throw g}}}),c},a.prototype._classifyUsersByGrade=function(a){var b=this,c={};for(var d in this._gradeTexts)c[d]=[];return a.forEach(function(a){var d=function(d){var e=a.sessions[d].text,f=function(d){if(c[d].indexOf(a)>=0)return"continue";var f=b._gradeTexts[d];f.forEach(function(b){e===b&&(a.grade=d,c[d].push(a))})};for(var g in b._gradeTexts){f(g)}};for(var e in a.sessions)d(e)}),c},a.prototype._setSessionProps=function(a){if(!a)return void w.classList.add("invisible");w.classList.remove("invisible");for(var b in a){var c=w.querySelector("."+b);if(c){var d=a[b];d.enabled?(c.classList.remove("off"),c.textContent=d.value):(c.classList.add("off"),c.textContent=".")}}},a.prototype._setPlayerProps=function(a){return a?void B.classList.remove("invisible"):void B.classList.add("invisible")},a.prototype._recreateWordIDsInEvents=function(a,b){if(a.length!==b.length)return void console.error("session and text page do not match");for(var c=function(c){var d=a[c].records;if(!d)return"continue";var e=new Map,f=b[c];f.forEach(function(a){var b=e.get(Math.round(a.y));b||(b=[],e.set(Math.round(a.y),b)),b.push({id:a.id,x:a.x,y:a.y,text:app.Syllabifier.clean(a.text)})}),d.forEach(function(a){var b=e.get(Math.round(a.rect.y));if(b){var c=app.Syllabifier.clean(a.text),f=b.filter(function(a){return a.text===c});if(1===f.length)a.id=f[0].id;else if(f.length>1){var g=d.filter(function(b){return b.rect.y===a.rect.y&&b.rect.x<a.rect.x&&app.Syllabifier.clean(b.text)===c});a.id=f[g.length].id}else console.log("no candidate for",c)}})},d=0;d<a.length;d++){c(d)}},a.prototype._getCanvas2D=function(){n&&m||(n=parseInt(window.getComputedStyle(r).width),m=parseInt(window.getComputedStyle(r).height),r.setAttribute("width",n),r.setAttribute("height",m));var a=r.getContext("2d");return a.clearRect(0,0,n,m),a},a.prototype._setCanvasFont=function(a,b){a.font=b.style+" "+b.weight+" "+b.size+" "+b.family},a.prototype._setTitle=function(a){q.textContent=a},a.prototype._drawSyllabifications=function(a,b,c){var d=this;a.textAlign="start",a.textBaseline="alphabetic",b.forEach(function(b){d._drawSyllabification(a,b,c)})},a.prototype._drawSyllabification=function(a,b,c){a.textAlign="start",a.textBaseline="alphabetic";var d=b.rect,e=app.Syllabifier.syllabify(b.text,c);a.fillStyle=this.syllabification.background,a.fillRect(d.x,d.y,d.width,d.height),a.fillStyle=this.syllabification.color,a.fillText(e,d.x,d.y+.8*d.height)},a.prototype._drawWords=function(a,b,c){var d=this,e=L();b.forEach(function(b,f){var g=Object.assign({alpha:app.Metric.getAlpha(b,d.colorMetric,c.metricRange),indexes:c.showIDs?e.feed(b.x,b.y):null},c);d._drawWord(a,b,g)})},a.prototype._drawWord=function(a,b,c){c.alpha>0,a.textAlign="start",a.textBaseline="alphabetic",a.fillStyle=this.wordColor,a.fillText(b.text,b.x,b.y+.8*b.height),c.alpha>0&&(a.fillStyle=app.Colors.rgb2rgba(this.wordHighlightColor,c.alpha),a.fillText(b.text,b.x,b.y+.8*b.height)),a.fillStyle="#fff";var d=app.Syllabifier.getPrefixAndSuffix(b.text,c.hyphen),e=_slicedToArray(d,2),f=e[0],g=e[1];f&&a.fillText(f,b.x,b.y+.8*b.height),g&&(a.textAlign="end",a.fillText(g,b.x+b.width,b.y+.8*b.height)),c.indexes&&(0===c.indexes.word&&(a.fillStyle=this.indexColors.line,a.textAlign="end",a.fillText(""+c.indexes.line,b.x-20,b.y+.8*b.height)),a.fillStyle=this.indexColors.word,a.textAlign="center",a.fillText(""+c.indexes.word,b.x+b.width/2,b.y)),c.hideBoundingBox||(a.strokeStyle=this.wordRectColor,a.lineWidth=1,a.strokeRect(b.x,b.y,b.width,b.height))},a.prototype._setPrevPageCallback=function(a){F=a},a.prototype._setNextPageCallback=function(a){G=a},a.prototype._setRestartCallback=function(a){I=a},a.prototype._setPauseCallback=function(a){J=a},a.prototype._setPageIndex=function(a){this._pageIndex=a,A.textContent=a?a+"/"+(this._data.text.length-1):"",this._enableNavigationButtons(this._pageIndex>0,this._pageIndex<this._data.text.length-1)},a.prototype._enableNavigationButtons=function(a,b){a?y.classList.remove("disabled"):y.classList.add("disabled"),b?z.classList.remove("disabled"):z.classList.add("disabled")},a.prototype._initializeSGWMSettings=function(){var SGWM=window.SGWM,a=void 0;a=new SGWM.FixationProcessorSettings,this._SGWM.FixationProcessorSettings=a,a.isInitialized||(a.location.enabled=!0,a.location.marginX=290,a.location.marginY=290,a.duration.enabled=!1,a.save()),a=new SGWM.SplitToProgressionsSettings,this._SGWM.SplitToProgressionsSettings=a,a.isInitialized||(a.bounds={left:-.5,right:8,verticalChar:2,verticalLine:.6},a.angle=Math.sin(15*Math.PI/180),a.save()),a=new SGWM.ProgressionMergerSettings,this._SGWM.ProgressionMergerSettings=a,a.isInitialized||(a.minLongSetLength=3,a.fitThreshold=.14,a.maxLinearGradient=.15,a.removeSingleFixationLines=!1,a.correctForEmptyLines=!0,a.currentLineSupportInCorrection=.15,a.emptyLineDetectorFactor=1.6,a.intelligentFirstLineMapping=!0,a.save()),a=new SGWM.WordMapperSettings,this._SGWM.WordMapperSettings=a,a.isInitialized||(a.wordCharSkipStart=3,a.wordCharSkipEnd=6,a.scalingDiffLimit=.9,a.rescaleFixationX=!1,a.partialLengthMaxWordLength=2,a.effectiveLengthFactor=.7,a.ignoreTransitions=!1,a.save())},a.prototype._map=function(a){Object.values(this._SGWM).forEach(function(a){a.save()});var b=new window.SGWM,c=b.map(a);return c},a.prototype._setCloseCallback=function(a){var b=this;H=function(){b._onClosed(),a&&a()}},a.prototype._onClosed=function(){this._pageIndex=-1,a.active=null};var m=void 0,n=void 0,o=void 0,p=void 0,q=void 0,r=void 0,s=void 0,t=void 0,u=void 0,v=void 0,w=void 0,x=void 0,y=void 0,z=void 0,A=void 0,B=void 0,C=void 0,D=void 0,E=void 0,F=void 0,G=void 0,H=void 0,I=void 0,J=void 0,K=!1,L=function(){var a=-1,b=-1,c=-1,d=-1;return{feed:function(e,f){return f>b?(d++,c=0):e>a&&c++,a=e,b=f,{word:c,line:d}}}};app.Visualization=a}(window.ReadVis2),function(app){function a(a){var b=this;this._container=document.querySelector(a.container),this._words=new Map;var c=app.Visualization.root.querySelector(".close");c.addEventListener("click",function(a){b._container.classList.add("invisible")});var d=this._container.querySelector(".button"),e=this._container.querySelector(".table");d.addEventListener("click",function(a){d.classList.toggle("dropped"),e.classList.toggle("invisible")})}a.instance=null,a.Units={MS:"ms",PERCENTAGE:"%"},a.prototype.show=function(){this._container.classList.remove("invisible")},a.prototype.clear=function(){this._words=new Map},a.prototype.fill=function(b){var c=this,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(b){d.preserve||(this._words=new Map);var e=d.hyphen||"-",f=this._container.querySelector(".table");f.innerHTML="";var g=0,h=new RegExp(""+e,"g"),i=function(a,b){return b[1].duration-a[1].duration};b.forEach(function(a){var b=a.id;void 0===b&&(b=""+Math.floor(a.rect.x/10)+"_"+Math.floor(a.rect.y/10));var d=c._words.get(b);d?d.duration+=a.duration:(d=Object.assign({},a),d.text=d.text.replace(h,""),c._words.set(b,d)),g+=d.duration}),this._words=new Map([].concat(_toConsumableArray(this._words.entries())).sort(i));var j=d.units||a.Units.MS;this._words.forEach(function(b){var c=b.duration;j===a.Units.MS?c=(Math.round(c)/1e3).toFixed(2):j===a.Units.PERCENTAGE&&(c=(100*c/g).toFixed(1)+"%");var d=document.createElement("span");d.classList.add("word"),d.textContent=b.text;var e=document.createElement("span");e.classList.add("duration"),e.textContent=c;var h=document.createElement("div");h.classList.add("record"),h.appendChild(d),h.appendChild(e),f.appendChild(h)})}},app.WordList=a}(window.ReadVis2),function(app){function a(a){this._container=document.querySelector(a.container),this.longFixationThreshold=1e3,app.Visualization.call(this,a),this.options={id:"word-replay",title:"Word replay",update:this.update.bind(this),options:app.Visualization.createOptions({longFixationThreshold:{type:Number,step:100,label:"Level duration, ms"}},this)},this._data=null,this._tracks=null}function b(a,b,c){this.root=a,this.name=b.meta.user,this.id=c,this.pointerSize=8,this.fixationTimer=null,this.nextTimer=null,this.session=b,this.fixations=null,this.words=null,this.fixationIndex=-1,this.__next=this._next.bind(this)}app.loaded(function(){a.prototype=Object.create(app.Visualization.prototype),a.prototype.base=app.Visualization.prototype,a.prototype.constructor=a,a.prototype._fillCategories=function(a,b){var c=this,d=this._getTexts(b);d.forEach(function(b,d){var e=c._addOption(a,d,b.title,b.sessions);c._data&&c._data.textID===d&&(e.selected=!0)})},a.prototype._load=function(a,c,d,e){var f=this,g=this._loadText(c,e),h=[g];d.forEach(function(a,b){app.WordList.instance.hyphen=a.interaction.syllabification.hyphen,h.push(f._loadSession(b,a))}),Promise.all(h).then(function(d){var g=_toArray(d),h=g[0],i=g.slice(1);f._data={textID:c,textTitle:e,text:h,sessions:i,hyphen:i[0].meta.interaction.syllabification.hyphen},b.colorIndex=0,f._tracks=[],i.forEach(function(a,c){f._tracks.push(new b(f._container,a,c))}),f._setPageIndex(0),f._start(),f._setPrevPageCallback(function(){f._prevPage()}),f._setNextPageCallback(function(){f._nextPage()}),f._setCloseCallback(function(){f._stopAll(),f._container.classList.add("invisible")}),a&&a()}).catch(function(a){window.alert(a)})},a.prototype._start=function(){if(this._tracks.length){this._getCanvas2D();this._setTitle('"'+this._data.text.title+'" for '+this._data.sessions.length+" sessions");var a=this._createTable(this._data.text[this._pageIndex],this._tracks);this._run(a),a.parentElement.scrollTop=0}},a.prototype._stopAll=function(){this._tracks&&this._tracks.forEach(function(a){return a.stop()})},a.prototype._createTable=function(a,b){var c=this._container.querySelector("table");c.innerHTML="";var d=new RegExp(""+this._data.hyphen,"g");a.forEach(function(a){var e=c.insertRow(),f=e.insertCell();f.textContent=a.text.replace(d,""),b.forEach(function(a){e.insertCell()})});var e=c.createTHead(),f=c.createTFoot(),g=e.insertRow(),h=f.insertRow();return g.insertCell(),h.insertCell(),b.forEach(function(a){g.insertCell().textContent=a.name;var b=h.insertCell();b.textContent="done",b.classList.add("hidden")}),this._container.classList.remove("invisible"),c},a.prototype._run=function(a){var b=this,c=a.querySelectorAll("tr"),d=this._data.text[this._pageIndex];this._tracks.forEach(function(a,e){var f={fixations:a.session[b._pageIndex].fixations,words:d},g=b._map(f);a.start(g,function(d,e,f){var g=a.words[d.id];g.totalDuration=g.totalDuration+e;var h=1+Math.floor(g.totalDuration/b.longFixationThreshold),i=255-24*Math.min(10,h),j="rgb("+i+","+i+","+i+")",k=c[d.id+1],l=k.cells[a.id+1];l.style.backgroundColor=j,a.pointer.style="left: "+(l.offsetLeft+(l.offsetWidth-a.pointerSize)/2)+"px;\n                                           top: "+(l.offsetTop+(l.offsetHeight-a.pointerSize)/2)+"px"},function(){var b=c[d.length+1],e=b.cells[a.id+1];e.classList.remove("hidden")})})},a.prototype._prevPage=function(){this._stopAll(),this._data&&this._pageIndex>0&&(this._setPageIndex(this._pageIndex-1),this._start())},a.prototype._nextPage=function(){this._stopAll(),this._data&&this._pageIndex<this._data.text.length-1&&(this._setPageIndex(this._pageIndex+1),this._start())}}),b.prototype.start=function(a,b,c){return this.onWordFixated=b,this.onCompleted=c,a.fixations?(this.fixations=a.fixations,this.words=a.text.words,this.words.forEach(function(a){a.totalDuration=0}),this.fixationIndex=0,this.pointer=document.createElement("div"),this.pointer.classList.add("pointer"),this.pointer.classList.add("invisible"),this.root.appendChild(this.pointer),void(this.nextTimer=setTimeout(this.__next,1500))):void c()},b.prototype.stop=function(){this.nextTimer&&(clearTimeout(this.nextTimer),this.nextTimer=null),this.fixationTimer&&(clearTimeout(this.fixationTimer),this.fixationTimer=null),this.pointer&&(this.root.removeChild(this.pointer),this.pointer=null)},b.prototype._next=function(){var a=this.fixations[this.fixationIndex];if(this._moveFixation(a.word,a.duration),this.fixationIndex++,this.fixationIndex<this.fixations.length){var b=this.fixations[this.fixationIndex].ts-a.ts;this.nextTimer=setTimeout(this.__next,b)}else this.onCompleted(),this.root.removeChild(this.pointer),this.pointer=null,this.nextTimer=null},b.prototype._moveFixation=function(a,b){var c=this;this.fixationTimer&&(clearTimeout(this.fixationTimer),this.fixationTimer=null),a?(this.onWordFixated(a,b,this.pointer),this.pointer.classList.remove("invisible"),this.fixationTimer=setTimeout(function(){c.fixationTimer=null,c.pointer&&c.pointer.classList.add("invisible")},b)):this.pointer.classList.add("invisible")},app.WordReplay=a}(window.ReadVis2);